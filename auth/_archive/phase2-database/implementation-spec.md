# Phase 2: Implementation Specification

## Migration Scripts

### Script 1: `001_better_auth.sql`

**Purpose**: Create Better Auth tables (auto-generated by Better Auth CLI)

**Command**:
```bash
npx better-auth migrate
```

This automatically creates all Better Auth tables. No manual SQL required.

---

### Script 2: `002_artorizer_user_link.sql`

**Purpose**: Add user_id to artwork_jobs table

**PostgreSQL**:
```sql
-- Add user_id column
ALTER TABLE "artwork_jobs"
ADD COLUMN "user_id" UUID;

-- Add foreign key constraint
ALTER TABLE "artwork_jobs"
ADD CONSTRAINT fk_artwork_user
  FOREIGN KEY ("user_id")
  REFERENCES "user"("id")
  ON DELETE SET NULL;

-- Add comment
COMMENT ON COLUMN "artwork_jobs"."user_id" IS 'User who uploaded this artwork (NULL for pre-auth uploads)';
```

**MySQL**:
```sql
ALTER TABLE `artwork_jobs`
ADD COLUMN `user_id` CHAR(36),
ADD CONSTRAINT fk_artwork_user
  FOREIGN KEY (`user_id`)
  REFERENCES `user`(`id`)
  ON DELETE SET NULL;
```

---

### Script 3: `003_indexes.sql`

**Purpose**: Create performance indexes

**PostgreSQL**:
```sql
-- Artwork user lookup (fast query: "my artworks")
CREATE INDEX idx_artwork_user ON "artwork_jobs"("user_id");

-- Artwork user + status (fast query: "my completed artworks")
CREATE INDEX idx_artwork_user_status ON "artwork_jobs"("user_id", "status");

-- Artwork created date (sorting)
CREATE INDEX idx_artwork_created ON "artwork_jobs"("created_at" DESC);

-- Composite for user's recent artworks
CREATE INDEX idx_artwork_user_created ON "artwork_jobs"("user_id", "created_at" DESC);
```

**MySQL**:
```sql
CREATE INDEX idx_artwork_user ON `artwork_jobs`(`user_id`);
CREATE INDEX idx_artwork_user_status ON `artwork_jobs`(`user_id`, `status`);
CREATE INDEX idx_artwork_created ON `artwork_jobs`(`created_at` DESC);
CREATE INDEX idx_artwork_user_created ON `artwork_jobs`(`user_id`, `created_at` DESC);
```

---

## Migration Runner

### File: `scripts/run-migrations.js`

**Purpose**: Run all migrations in order

```javascript
/**
 * Database Migration Runner
 *
 * Runs all migration scripts in order.
 * Usage: node scripts/run-migrations.js
 */

import fs from 'fs';
import path from 'path';
import { Pool } from 'pg';  // or mysql2/promise
import 'dotenv/config';

const pool = new Pool({
  host: process.env.DB_HOST,
  port: process.env.DB_PORT,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME
});

async function runMigration(filename) {
  const filepath = path.join(process.cwd(), 'migrations', filename);
  const sql = fs.readFileSync(filepath, 'utf8');

  console.log(`Running migration: ${filename}`);

  try {
    await pool.query(sql);
    console.log(`✅ ${filename} completed`);
  } catch (error) {
    console.error(`❌ ${filename} failed:`, error.message);
    throw error;
  }
}

async function main() {
  try {
    // Migration 1: Better Auth tables (run via CLI instead)
    console.log('Step 1: Run Better Auth migration');
    console.log('Execute: npx better-auth migrate');

    // Migration 2: Artorizer user link
    await runMigration('002_artorizer_user_link.sql');

    // Migration 3: Indexes
    await runMigration('003_indexes.sql');

    console.log('\n✅ All migrations completed successfully');
  } catch (error) {
    console.error('\n❌ Migration failed:', error);
    process.exit(1);
  } finally {
    await pool.end();
  }
}

main();
```

---

## Rollback Scripts

### File: `migrations/rollback_002.sql`

**Purpose**: Rollback user_id addition

**PostgreSQL**:
```sql
ALTER TABLE "artwork_jobs"
DROP CONSTRAINT IF EXISTS fk_artwork_user,
DROP COLUMN IF EXISTS "user_id";
```

---

### File: `migrations/rollback_003.sql`

**Purpose**: Remove indexes

**PostgreSQL**:
```sql
DROP INDEX IF EXISTS idx_artwork_user;
DROP INDEX IF EXISTS idx_artwork_user_status;
DROP INDEX IF EXISTS idx_artwork_created;
DROP INDEX IF EXISTS idx_artwork_user_created;
```

---

## Helper Functions

### Function: `checkMigrationStatus()`

**Purpose**: Check which migrations have been applied

```javascript
/**
 * Check Migration Status
 *
 * Queries database to see which tables/columns exist
 */
export async function checkMigrationStatus() {
  const pool = new Pool({ /* config */ });

  // Check Better Auth tables
  const tablesResult = await pool.query(`
    SELECT table_name
    FROM information_schema.tables
    WHERE table_schema = 'public'
    AND table_name IN ('user', 'account', 'session', 'verification')
  `);

  const tables = tablesResult.rows.map(r => r.table_name);

  // Check user_id column
  const columnResult = await pool.query(`
    SELECT column_name
    FROM information_schema.columns
    WHERE table_name = 'artwork_jobs'
    AND column_name = 'user_id'
  `);

  const hasUserId = columnResult.rows.length > 0;

  // Check indexes
  const indexResult = await pool.query(`
    SELECT indexname
    FROM pg_indexes
    WHERE tablename = 'artwork_jobs'
    AND indexname LIKE 'idx_artwork_%'
  `);

  const indexes = indexResult.rows.map(r => r.indexname);

  await pool.end();

  return {
    betterAuthTables: tables,
    hasUserId,
    indexes
  };
}
```

---

### Function: `seedTestData()`

**Purpose**: Insert sample data for testing

```javascript
/**
 * Seed Test Data
 *
 * Inserts sample users and artworks for testing
 */
export async function seedTestData() {
  const pool = new Pool({ /* config */ });

  // Insert test user
  await pool.query(`
    INSERT INTO "user" (id, email, emailVerified, name, image)
    VALUES (
      '550e8400-e29b-41d4-a716-446655440000',
      'test@artorizer.com',
      TRUE,
      'Test Artist',
      'https://via.placeholder.com/150'
    )
    ON CONFLICT (email) DO NOTHING
  `);

  // Insert test Google account
  await pool.query(`
    INSERT INTO "account" (userId, provider, providerAccountId)
    VALUES (
      '550e8400-e29b-41d4-a716-446655440000',
      'google',
      'test_google_123'
    )
    ON CONFLICT (provider, providerAccountId) DO NOTHING
  `);

  // Insert test artwork
  await pool.query(`
    INSERT INTO "artwork_jobs" (
      user_id,
      job_id,
      original_filename,
      original_url,
      status
    )
    VALUES (
      '550e8400-e29b-41d4-a716-446655440000',
      'test_job_123',
      'test_artwork.jpg',
      'https://cdn.artorizer.com/test/artwork.jpg',
      'completed'
    )
    ON CONFLICT (job_id) DO NOTHING
  `);

  await pool.end();

  console.log('✅ Test data seeded successfully');
}
```

---

## Verification Queries

### Query: Check All Tables Exist
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;
```

### Query: Count Users
```sql
SELECT COUNT(*) as user_count FROM "user";
```

### Query: Count Artworks Per User
```sql
SELECT
  u.email,
  u.name,
  COUNT(a.id) as artwork_count
FROM "user" u
LEFT JOIN "artwork_jobs" a ON u.id = a.user_id
GROUP BY u.id, u.email, u.name
ORDER BY artwork_count DESC;
```

### Query: Check Foreign Keys
```sql
SELECT
  tc.constraint_name,
  tc.table_name,
  kcu.column_name,
  ccu.table_name AS foreign_table,
  ccu.column_name AS foreign_column
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage ccu
  ON tc.constraint_name = ccu.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
ORDER BY tc.table_name;
```

---

## Implementation Checklist

- [ ] Run Better Auth migration: `npx better-auth migrate`
- [ ] Create `migrations/002_artorizer_user_link.sql`
- [ ] Create `migrations/003_indexes.sql`
- [ ] Create `scripts/run-migrations.js`
- [ ] Run migration script: `node scripts/run-migrations.js`
- [ ] Verify tables exist
- [ ] Verify user_id column exists
- [ ] Verify indexes created
- [ ] Verify foreign keys created
- [ ] (Optional) Seed test data
- [ ] Document rollback procedures

---

## Success Criteria

1. ✅ Better Auth tables created
2. ✅ `user_id` column added to `artwork_jobs`
3. ✅ Foreign key constraint created
4. ✅ Indexes created
5. ✅ Verification queries pass
6. ✅ Can insert test user
7. ✅ Can link artwork to user
8. ✅ Rollback scripts prepared
